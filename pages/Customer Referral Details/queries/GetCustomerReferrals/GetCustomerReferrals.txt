with customer_base as (
    select 
        ci.id as customer_id, 
        ce.email_address, 
        count(distinct ed.id) as orders
    from public.customer_info ci 
    left join public.customer_email ce 
        on ci.id = ce.customer_id 
    left join entity.v_entity_details ed 
        on ci.id = ed.customer_id 
        and ce.email_provider = ed.email_provider
        and date(ce.created_at) <= date(ed.order_placed_date)
    where ci.status='ACTIVE' and ce.email_provider='FMAIL'
    group by 1,2
), 
referrals_transaction_base as (
    select t.user_id, 
        rpl.amount as referral_user_amount, 
        rpl.description as referral_user_description, 
        rpl.created_at as referral_rewared_received_on,
        meta_info->'type' as transaction_type, 
        meta_info->'metaInfo'->>'refereeId' as refree_id, 
        meta_info->'metaInfo'->>'refereeCampaignId' as refree_campaign_id,
        meta_info->'metaInfo'->>'referrerCampaignId' as referrer_campaign_id
    from rewards.transactions t 
    left join rewards.rewards_point_ledger rpl 
        on t.id = rpl.transaction_id
    where meta_info->'type'='"REFERRAL"'
), 
referee_transaction_base as (
    select 
        t.user_id, 
        rpl.amount as referee_user_amount, 
        rpl.description as referee_user_description, 
        rpl.created_at as referee_rewared_received_on,
        meta_info->'type' as transaction_type
    from rewards.transactions t 
    left join rewards.rewards_point_ledger rpl 
        on t.id = rpl.transaction_id
    where meta_info->'type'='"REFERRAL"'
)
select 
    uic.user_id, 
    cb.email_address as referral_email_address,
    uic.user_invite_count as referral_invite_count,
    r1.referral_user_amount, 
    r1.referral_rewared_received_on, 
    
    ui.user_id as referee_user_id, 
    ui.created_at as referee_created_at, 
    cb2.email_address as refree_email_address, 
    cb2.orders as referee_orders,
    cr.status as referee_status, 
    r2.referee_user_amount,
    r2.referee_rewared_received_on
from user_invite_codes uic 
left join public.user_invitation ui 
    on cast(uic.id as text) = cast(ui.user_invite_code_id as text)
left join customer_base cb 
    on uic.user_id = cb.customer_id
left join customer_base cb2 
    on ui.user_id = cb2.customer_id
left join (
    select ni.user_id, ni.campaign_id, cast(ni.data->>'refereeId' as text) as refree_id, status
    from campaigns.node_instances ni 
    where ni.campaign_id in (select id from campaigns.campaigns c where c.campaign_type = 'REFERRAL_CAMPAIGN' and c.group_key = 'REFERRER_CAMPAIGN') 
) cr 
    on uic.user_id = cr.user_id
    and cast(ui.user_id as text) = cr.refree_id
left join referrals_transaction_base r1 
    on uic.user_id = r1.user_id 
    and cast(ui.user_id as text) = cast(r1.refree_id as text)
left join referee_transaction_base r2 
    on cast(ui.user_id as text) = cast(r2.user_id as text)
where uic.user_invite_count>0 and cb.email_address = '{{InputFlashId.inputText}}'
order by 1,3